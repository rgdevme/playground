name: Deploy Affected Nx Targets to GitHub Pages

on:
  push:
    # Trigger the workflow only when pushing to the main branch
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Set the default branch name for Nx affected comparison
      NX_BASE_BRANCH: main

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Fetch all history for proper base/head comparison
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # Use 'yarn' or 'pnpm' if you use those package managers

      - name: Install Dependencies
        run: npm install

      # -----------------------------------------------------------
      # 1. NX CACHING AND AFFECTED BUILD
      # -----------------------------------------------------------

      - name: Cache Nx Build Results
        uses: actions/cache@v4
        with:
          path: ./.nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/project.json') }}
          restore-keys: |
            ${{ runner.os }}-nx-${{ hashFiles('package-lock.json') }}-

      - name: Get Base SHA for Affected Check
        id: base
        # This determines the commit hash to compare against (e.g., the last commit on the main branch)
        run: echo "SHA=$(git rev-parse origin/${{ env.NX_BASE_BRANCH }}~1)" >> $GITHUB_OUTPUT
        
      - name: Build Affected Targets
        run: |
          echo "Building affected projects compared to base commit: ${{ steps.base.outputs.SHA }}"
          # Use the affected command to build only projects that have changed.
          # We use the SHA from the base branch to ensure a correct comparison.
          npx nx affected:build --all --base=${{ steps.base.outputs.SHA }} --head=HEAD --parallel --configuration=production

      # -----------------------------------------------------------
      # 2. DEPLOYMENT TO GITHUB PAGES
      # -----------------------------------------------------------
      
      # IMPORTANT: Adjust the path here to the correct 'dist' folder for your deployable application.
      # For example, if you want to deploy an app named 'docs', use 'dist/docs'.
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Deployment Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist  # <-- CRITICAL: REPLACE 'dist/my-app' with your target app's output directory

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
