# .github/workflows/deploy.yml

name: 'Build Affected & Deploy to GitHub Pages'

on:
  push:
    # Trigger the workflow only when pushing to the main branch
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4
        with:
          # Required to get the full history for nx affected commands
          fetch-depth: 0

      - name: 🛠️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24' # Use your required Node version
          cache: 'npm' # Or 'yarn', 'pnpm'

      - name: 📦 Install Dependencies
        run: npm install # Or 'yarn install', 'pnpm install'

      # -----------------------------------------------------------
      # 1. NX CACHING AND AFFECTED BUILD
      # -----------------------------------------------------------

      - name: 🔍 Determine affected projects and set SHAs
        # Sets NX_BASE and NX_HEAD environment variables for the build step
        uses: nrwl/nx-set-shas@v4
        with:
          # Use your main branch name if it's not 'main'
          main-branch-name: 'main'

      - name: ⚙️ Build Affected Targets
        id: build-affected
        run: |
          npx nx run-many -t build --skip-nx-cache

      - name: ⬆️ Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: ⏫ Upload GitHub Pages Artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: dist

      - name: 🚢 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4